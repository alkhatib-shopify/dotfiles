#!/bin/sh

# When a local hotfix branch is completed, we need to:
#  1. merge into master
#  2. merge into develop
#  3. delete the remote branch
#  4. delete the local branch
# This script attempts to do all that, avoiding conflicts
#  example: git hotfix-finish hotfix/BOOS-3382
# When one command fails, the entire command fails and you'll need
# to pick up where it left off manually.

set -e

merge_into() {
  git checkout "$1"
  git pull
  git merge --no-ff "$current"
  git push origin "$1"
}

git checkout "$1"

current=$(git rev-parse --abbrev-ref HEAD)
upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @"{u}" | sed "s/origin\///")

git fetch
git rebase origin/master
git push -f origin "$current"
merge_into "master"
merge_into "develop"
git push origin --delete "$upstream"
git branch -d "$current"
git checkout master
